@model IEnumerable<SelectListItem>
<h1>Player Report Cards</h1>
<h3>Select Term and Squad</h3>
<div class="row">
    <div class="col-md-12" style="margin-bottom:15px;">
        <div class="form-inline">
            <div class="form-group">
                @*<label for="term">Term:</label>*@
                <select id="terms" name="terms" class="form-control" style="width:200px;"></select>
            </div>
            <div class="form-group">
                @*<label for="Squad" class="control-label">Squads:</label>*@
                <select id="squads" name="squads" asp-items="Model" class="form-control" style="width:200px;"></select>
            </div>
        </div>
    </div>
</div>

<div id="message">No records found</div>
<div class="table-responsive" style="display:none">
    <table id="reportCardsTable" class="table table-bordered table-hover">
        <thead>
            <tr>
                <th class="col-md-5">Player Name</th>
                <th class="text-center col-md-1">Squad#</th>
                <th class="text-center col-md-1">Report Card</th>
                <th class="text-center col-md-3">Action</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<div class="modal fade" id="reportModal" role="dialog">
    <div class="modal-dialog modal-sm">
        <!-- Modal content-->
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title">Modal Header</h4>
            </div>
            <div class="modal-body">
                
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            </div>
        </div>

    </div>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    <script src="~/lib/select2/dist/js/select2.min.js"></script>
    <script>
        var dialogBody = $('#reportModal div.modal-body');
        var dialogHeader = $('#reportModal h4.modal-title');
        var dialog = $('#reportModal > div.modal-dialog');
        var squadDropdown = $('#squads').select2({ placeholder: 'select squad...' });
        var termDropdown = $('#terms').select2({
            ajax: {
                url: '/api/evaluations/terms?',
                data: function (params) {
                    var query = {
                        q: params.term,
                        page: 1
                    };
                    return query;
                },
                processResults: function (data) { return { results: data.results.hits }; }
            },
            minimumInputLength: 1,
            placeholder: 'select term...',
            templateResult: resultStyles,
            templateSelection: resultStyles
        });

        function resultStyles(selection) {
            if (selection.status && selection.status == "Closed") {
                return $("<span style='text-decoration: line-through;'>" + selection.text + "</span>");
            }               

            return selection.text;
        }

        $("#terms").change(refreshReportCardTable);
        $("#squads").change(refreshReportCardTable);

        function refreshReportCardTable() {
            var termId = $("#terms").val();    
            var squadId = $("#squads").val();

            if (squadId != null && termId != null) {
                $(".table-responsive").hide();
                $("#reportCardsTable > tbody").empty();
                $("#message").text("Fetching data, please wait...");
                $("#message").show();
                fetchReportCards(termId, squadId);
            } else {
                $("#message").text("No records found");
                $("#message").show();
            }
        }

        function fetchReportCards(termId, squadId) {            
            $.ajax({
                method: "GET",
                url: "/api/evaluations/report-cards?termId=" + termId + "&squadId=" + squadId
            })
            .done(function (data) {
                if (data.results.length == 0) {
                    $(".table-responsive").hide();
                    $("#message").show();
                    $("#message").text("No records found");
                } else {
                    displayReportCards(data);    
                }                
            });
        }

        function displayReportCards(data) {
            var reportCards = data.results;
            var term = data.term;
            var isTermOpen = (data.term.status == "Open");

            for (var i = 0; i < reportCards.length; i++) {
                var reportCard = reportCards[i];
                var actionDropdown = "", actionDropDownOptions = "";              

                if (reportCard.reportCardExists) {
                    actionDropDownOptions += "<li><a href='#' class='printReport'><span class='glyphicon glyphicon glyphicon-print' aria-hidden='true'></span> Print</a></li>";                    
                }
                if (isTermOpen == true && reportCard.reportCardExists == false) {
                    actionDropDownOptions += "<li><a href='#' class='generateReport'><span class='text-default glyphicon glyphicon glyphicon-cog' aria-hidden='true'></span> Generate</a></li>";
                }
                if (isTermOpen == true && reportCard.reportCardExists == true) {
                    actionDropDownOptions += "<li><a href='#' class='deleteReport'><span class='text-danger glyphicon glyphicon glyphicon-remove' aria-hidden='true'></span> Delete</a></li>";
                }                

                if (actionDropDownOptions.length > 0) {
                    actionDropdown = "<div class='dropdown'>" +
                        "<button class='btn btn-default dropdown-toggle btn-sm' type='button' id='dropdownMenu1' data-toggle='dropdown' aria- haspopup='true' aria-expanded='true' >" +
                        "<span class='caret'></span></button><ul class='dropdown-menu dropdown-menu-right' aria-labelledby='dropdownMenu1'>" + actionDropDownOptions + "</ul>";
                }

                var row = "<tr data-playerid='" + reportCard.playerId + "' data-reportcardid = '" + reportCard.playerReportCardId + "'>";

                if (reportCard.reportCardExists) {
                    row = row + "<td>" + reportCard.playerName + "</td>";
                } else {
                    row = row + "<td>" + reportCard.playerName + "</td>";
                }

                row = row + "<td class='text-center'>" + reportCard.squadNumber + "</td>"; 
                row = row + "<td class='text-center'>" + (reportCard.reportCardExists ? "<a href='#'><span class='glyphicon glyphicon glyphicon-file'></span></a>" : "") + "</td>";
                row = row + "<td class='text-center'>" + actionDropdown + "</td></tr>";
                $("#reportCardsTable > tbody").append(row);
            }
            $(".table-responsive").show();
            $("#message").hide();
            attachEvents();
        }

        function attachEvents() {
            $('a.generateReport').on('click', function (e) {
                console.log("clicked");
                var context = getReportCardContext($(this.closest("tr")));
                console.log(context.playerId + " - " + context.reportCardId);  
                promptTemplateSelection(context);
            });
        }        

        function getReportCardContext(record) {
            return { playerId: record.data('playerid'), reportCardId: record.data('reportcardid') };
        }

        function promptTemplateSelection(context) {
            dialog.removeClass("modal-lg").removeClass("modal-sm");
            dialogHeader.text("Select Report Template");
            dialogBody.empty().append("<p class='modal-message'>Fetching report templates, please wait....</p>");
            $('#reportModal').modal({ show: true });

            var playerContext = context;
            $.ajax({
                method: "GET",
                url: "/api/evaluations/report-designs"
            })
            .done(function (data) {
                if (data.results.length == 0) {
                    $(".table-responsive").hide();
                    $("#message").show();
                    $("#message").text("No records found");
                } else {
                    displayReportDesigns(data, playerContext);
                }
            });
        }

        function displayReportDesigns(data, context) {
            console.log("player " + context.playerId);
            if (data.results.length > 0) {
                dialogBody.empty()
                    .append("<table class='table table-borderless report-template-list'></table>");

                for (var i = 0; i < data.results.length; i++) {
                    var template = data.results[i];
                    $('.report-template-list').append("<tr data-reporttemplateid='" + template.reportDesignId + "'><td><button type='button' class='btn btn-link report-template-button'>" + template.name + "</button></td></tr>");
                }

                $(".report-template-button").on("click", function (e) {
                    var reportTemplateId = $(this).closest('tr').data('reporttemplateid');
                    generateReportCard(context.playerId, reportTemplateId);
                });

            } else { 
                dialogBody.empty().append("<p class='modal-message'>No report template found. Please create a report template.</div>");
            }
        }

        function generateReportCard(playerId, reportDesignId) {
            //console.log("player: " + playerId + ", report design id: " + reportTemplateId);
            var termId = termDropdown.val();
            var squadId = squadDropdown.val();
            updateDialogStatus("Generating report. Please wait...");

            $.ajax({
                method: "POST",
                url: "/api/evaluations/report-cards/new",
                data: { squadId: squadId, termId: termId, playerId: playerId, reportDesignId: reportDesignId }
            })
            .done(function (data) {
                console.log("done generating report");
                })
            .fail(function () {
                updateDialogStatus("There was an error generating the report. Please contact your administrator");
            });
        }

        function updateDialogStatus(message) {
            $("p.status").remove();
            dialogBody.append("<p class='status'>" + message + "</p>");
        }

    </script>
}

@section CSS {
    <link href="~/lib/select2/dist/css/select2.min.css" rel="stylesheet" />
}